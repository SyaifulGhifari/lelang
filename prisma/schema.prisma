// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  phone             String   @unique
  name              String
  avatar            String?
  password          String?
  role              Role     @default(USER)
  status            UserStatus @default(ACTIVE)
  phoneVerified     Boolean  @default(false)
  otpCode           String?
  otpExpiredAt      DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  bids              Bid[]
  auctions          Auction[]
  transactions      Transaction[]
  reviews           Review[]
  watchlist         Watchlist[]
  notifications     Notification[]
  wonAuctions       Auction[] @relation("WonAuctions")

  @@index([email])
  @@index([phone])
  @@index([role])
}

enum Role {
  ADMIN
  USER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// ============================================
// Auction System
// ============================================

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  description String?
  icon      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auctions  Auction[]

  @@index([slug])
}

model Auction {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  description     String   @db.Text
  condition       String   // Baru, Bekas, Refurbished
  startingPrice   Float
  reservePrice    Float?
  buyNowPrice     Float?
  currentPrice    Float
  bidIncrement    Float    @default(10000)
  startTime       DateTime
  endTime         DateTime
  status          AuctionStatus @default(ACTIVE)
  isHighlighted   Boolean  @default(false)
  isFeatured      Boolean  @default(false)
  viewCount       Int      @default(0)
  weight          Float?
  shippingCost    Float?
  shippingInfo    String?
  location        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  sellerId        String
  seller          User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id])
  winnerId        String?
  winner          User?    @relation("WonAuctions", fields: [winnerId], references: [id])
  images          AuctionImage[]
  bids            Bid[]
  transactions    Transaction[]
  reviews         Review[]
  watchlist       Watchlist[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([winnerId])
  @@index([status])
  @@index([slug])
  @@map("auctions")
}

model AuctionImage {
  id        String   @id @default(cuid())
  url       String
  publicId  String?
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([auctionId])
}

enum AuctionStatus {
  DRAFT
  ACTIVE
  ENDED
  SOLD
  CANCELLED
}

// ============================================
// Bidding System
// ============================================

model Bid {
  id        String   @id @default(cuid())
  amount    Float
  isAutoBid Boolean  @default(false)
  maxBid    Float?
  status    BidStatus @default(ACTIVE)
  createdAt DateTime @default(now())

  // Relations
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bidderId  String
  bidder    User     @relation(fields: [bidderId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([bidderId])
  @@index([status])
}

enum BidStatus {
  ACTIVE
  OUTBID
  WON
  CANCELLED
}

// ============================================
// Payment & Transactions
// ============================================

model Transaction {
  id            String   @id @default(cuid())
  type          TransactionType
  amount        Float
  status        TransactionStatus @default(PENDING)
  paymentId     String?  @unique
  paymentUrl    String?
  paidAt        DateTime?
  expiredAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  auctionId     String?
  auction       Auction? @relation(fields: [auctionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([auctionId])
  @@index([status])
  @@index([paymentId])
}

enum TransactionType {
  PAYMENT
  REFUND
  COMMISSION
}

enum TransactionStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  EXPIRED
}

// ============================================
// Reviews & Ratings
// ============================================

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  comment   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([userId])
}

// ============================================
// Watchlist
// ============================================

model Watchlist {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@unique([userId, auctionId])
  @@index([userId])
  @@index([auctionId])
}

// ============================================
// Notifications
// ============================================

model Notification {
  id        String   @id @default(cuid())
  type      NotificationType
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  OUTBID
  WON
  PAYMENT_REMINDER
  AUCTION_ENDING
  AUCTION_STARTED
  AUCTION_ENDED
  REVIEW_REQUEST
  SYSTEM
}

// ============================================
// NextAuth
// ============================================

model Account {
  id                 String @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String @id @default(cuid())
  sessionToken String @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
