// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  phone             String?
  name              String
  username          String?   @unique
  avatar            String?
  password          String?
  address           String?
  city              String?
  province          String?
  postalCode        String?
  role              UserRole @default(USER)
  status            UserStatus @default(ACTIVE)
  phoneVerified     Boolean  @default(false)
  emailVerified     DateTime?
  otpCode           String?
  otpExpiredAt      DateTime?
  lastLoginAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  bids              Bid[]
  auctions          Auction[]
  transactions      Transaction[]
  reviews           Review[]        @relation("ReviewAuthor")
  receivedReviews   Review[]        @relation("ReviewTarget")
  watchlist         Watchlist[]
  notifications     Notification[]
  wonAuctions       Auction[] @relation("WonAuctions")
  accounts          Account[]
  sessions          Session[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

// ============================================
// Auction System
// ============================================

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  description String?
  icon      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auctions  Auction[]

  @@index([slug])
}

model Auction {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  description     String   @db.Text
  condition       String   // NEW, LIKE_NEW, GOOD, FAIR
  startingPrice   Decimal       @db.Decimal(15, 2)
  reservePrice    Decimal?      @db.Decimal(15, 2)
  buyNowPrice     Decimal?      @db.Decimal(15, 2)
  currentPrice    Decimal       @db.Decimal(15, 2)
  bidIncrement    Decimal       @default(10000) @db.Decimal(15, 2)
  startTime       DateTime
  endTime         DateTime
  status          AuctionStatus @default(DRAFT)
  isHighlighted   Boolean  @default(false)
  isFeatured      Boolean  @default(false)
  viewCount       Int      @default(0)
  weight          Decimal?      @db.Decimal(10, 2)
  shippingCost    Decimal?      @db.Decimal(15, 2)
  shippingInfo    String?
  location        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  sellerId        String
  seller          User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id])
  winnerId        String?
  winner          User?    @relation("WonAuctions", fields: [winnerId], references: [id])
  images          AuctionImage[]
  bids            Bid[]
  transactions    Transaction[]
  reviews         Review[]
  watchlist       Watchlist[]

  @@index([sellerId])
  @@index([categoryId])
  @@index([winnerId])
  @@index([status, endTime])
  @@index([slug])
  @@map("auctions")
}

model AuctionImage {
  id        String   @id @default(cuid())
  url       String
  publicId  String?
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([auctionId])
}

enum AuctionStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  ENDED
  SOLD
  CANCELLED
}

// ============================================
// Bidding System
// ============================================

model Bid {
  id        String   @id @default(cuid())
  amount    Decimal       @db.Decimal(15, 2)
  isAutoBid Boolean  @default(false)
  maxBid    Decimal?      @db.Decimal(15, 2)
  status    BidStatus @default(ACTIVE)
  createdAt DateTime @default(now())

  // Relations
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bidderId  String
  bidder    User     @relation(fields: [bidderId], references: [id], onDelete: Cascade)

  @@index([auctionId, amount])
  @@index([bidderId])
  @@index([status])
  @@map("bids")
}

enum BidStatus {
  ACTIVE
  OUTBID
  WON
  CANCELLED
}

// ============================================
// Payment & Transactions
// ============================================

model Transaction {
  id            String   @id @default(cuid())
  type          TransactionType
  amount        Decimal       @db.Decimal(15, 2)
  fee           Decimal       @default(0) @db.Decimal(15, 2)
  status        PaymentStatus @default(PENDING)
  paymentMethod String?
  paymentId     String?  @unique
  paymentUrl    String?
  paymentData   Json?
  notes         String?
  paidAt        DateTime?
  expiredAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  auctionId     String?
  auction       Auction? @relation(fields: [auctionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([auctionId])
  @@index([status])
  @@index([paymentId])
  @@map("transactions")
}

enum TransactionType {
  PAYMENT
  REFUND
  COMMISSION
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  EXPIRED
}

// ============================================
// Reviews & Ratings
// ============================================

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  comment   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auctionId String?
  auction   Auction? @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  targetId  String
  target    User     @relation("ReviewTarget", fields: [targetId], references: [id])

  @@unique([authorId, targetId, auctionId])
  @@index([auctionId])
  @@index([authorId])
  @@index([targetId])
  @@map("reviews")
}

// ============================================
// Watchlist
// ============================================

model Watchlist {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  auctionId String
  auction   Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@unique([userId, auctionId])
  @@index([userId])
  @@index([auctionId])
}

// ============================================
// Notifications
// ============================================

model Notification {
  id        String   @id @default(cuid())
  type      NotificationType
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  OUTBID
  WON
  PAYMENT_REMINDER
  AUCTION_ENDING
  AUCTION_STARTED
  AUCTION_ENDED
  REVIEW_REQUEST
  SYSTEM
}

// ============================================
// NextAuth
// ============================================

model Account {
  id                 String @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user               User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String @id @default(cuid())
  sessionToken String @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}
